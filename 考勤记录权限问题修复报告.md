# 考勤记录权限问题修复报告

## 问题描述

教师用户 teacher001 访问自己的课程考勤记录时，出现"没有权限操作该课程"的错误。

## 问题分析

通过分析前端日志和后端日志，发现了以下问题：

### 1. 前端日志显示
- 第81行：`{code: 500, message: '没有权限操作该课程'}`
- 第160行：`获取学生列表失败: Error: 没有权限操作该课程`
- 访问路径：`POST /api/teacher/courses/students/4`
- 参数：`teacherId: 1, courseId: 4`

### 2. 后端日志显示
- 用户已正确认证，拥有 teacher 角色和相关权限
- Spring Security 权限检查通过
- 但业务层权限检查失败

## 根本原因

在 `TeacherServiceImpl.java` 中，有两处调用 `checkTeacherCoursePermission` 方法时**参数顺序错误**：

### Mapper接口定义
```java
int checkTeacherCoursePermission(@Param("teacherId") Long teacherId, @Param("courseId") Long courseId);
```

### 错误的调用（第256行和第326行）
```java
teacherMapper.checkTeacherCoursePermission(courseId, teacherId); // 参数顺序反了！
```

### 正确的调用应该是
```java
teacherMapper.checkTeacherCoursePermission(teacherId, courseId);
```

## 修复内容

### 1. 前端修复
**文件：** `前端/src/views/attendance/record/index.vue`

**修改内容：** 改进了教师用户权限判断逻辑
- 添加了对 `teacher` 角色的明确检查
- 当教师用户缺少 `teacherId` 时，尝试重新获取用户信息
- 改进了错误提示消息

### 2. 后端修复

#### 修复1：参数顺序错误（关键修复）
**文件：** `后端/src/main/java/com/example/student/service/impl/TeacherServiceImpl.java`

**修改位置：**
- 第256行：`getTeacherCourseStudents` 方法
- 第326行：`submitStudentAttendance` 方法

**修改内容：**
```java
// 修改前
int count = teacherMapper.checkTeacherCoursePermission(courseId, teacherId);

// 修改后
int count = teacherMapper.checkTeacherCoursePermission(teacherId, courseId);
```

#### 修复2：添加调试日志
**文件：** `后端/src/main/java/com/example/student/service/impl/LoginServiceImpl.java`

**修改内容：** 在 `login` 和 `getUserInfo` 方法中添加日志，便于调试教师ID获取问题
```java
System.out.println("查询教师信息 - userId: " + user.getId() + ", teacher: " + teacher);
System.out.println("教师用户 " + user.getUsername() + " 的teacherId: " + teacherId);
```

## 验证方法

### 1. 数据库验证
检查 teacher 表中教师数据：
```sql
SELECT t.id, t.teacher_no, t.user_id, u.username, u.name
FROM teacher t
JOIN sys_user u ON t.user_id = u.id
WHERE u.username = 'teacher001';
```

预期结果：teacher001 对应的 user_id=3，teacherId=1

### 2. 课程开设验证
检查教师是否是该课程的授课教师：
```sql
SELECT co.id, co.course_id, co.teacher_id, c.course_name
FROM course_offering co
JOIN course c ON co.course_id = c.id
WHERE co.id = 4 AND co.teacher_id = 1;
```

### 3. 权限检查验证
执行修复后的权限检查SQL：
```sql
SELECT COUNT(*)
FROM course_offering
WHERE id = 4 AND teacher_id = 1;
```

预期结果：返回 1（表示有权限）

## 部署步骤

### 1. 后端部署
```bash
cd 后端
mvn clean package -DskipTests
# 重启后端服务
```

### 2. 前端部署
前端已自动保存，刷新浏览器即可。

### 3. 测试
1. 使用 teacher001 登录系统
2. 进入"课程开设"页面
3. 点击任意一门自己的课程的"考勤记录"按钮
4. 确认能够正常进入考勤记录页面并查看学生列表

## 影响范围

### 受影响的功能
1. 教师查看课程学生列表（考勤记录）
2. 教师提交学生考勤
3. （可能）教师提交学生成绩

### 不受影响的功能
- 管理员访问考勤记录（teacherId 为 null）
- 其他权限检查功能

## 后续建议

1. **代码审查**：检查其他地方是否有类似的参数顺序错误
2. **单元测试**：为权限检查方法添加单元测试，防止类似问题再次发生
3. **日志优化**：将调试日志改为使用日志框架（如 log.debug）而不是 System.out.println
4. **参数命名**：考虑使用更明确的参数名或添加注释，避免混淆

## 总结

本次问题的根本原因是方法调用时参数顺序错误，导致业务层权限检查失败。通过修复参数顺序，问题得到解决。同时也暴露了代码缺乏单元测试的问题，建议后续加强测试覆盖。

